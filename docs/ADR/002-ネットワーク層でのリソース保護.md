# ADR 002: ネットワーク層でのリソース保護対策

## 日時

2025-04-07

## コンテキスト

ADR-001では、JWT認証によるアプリケーションレベルでの保護を検討したが、これだけではCloudflare Workersのリソース消費問題を根本的に解決できないことが明らかになった。JWT認証のみでは以下の課題が残る：

1. **リクエスト処理オーバーヘッド**: 認証が失敗しても、リクエスト自体はCloudflare Workersで処理されるため、リソースは消費される
2. **認証エンドポイントの脆弱性**: 認証エンドポイント自体が攻撃対象となり得る
3. **DoS攻撃の可能性**: 大量のリクエストが送信された場合、認証処理自体がリソースを消費する

Effective Yomimonoは個人利用のプロジェクトであり、パブリックなインターネット上で公開URLを持つことによるリスクを最小化する必要がある。

## 決定

**Cloudflareのネットワーク層機能を活用した多層防御アプローチを採用する。**

具体的には：

1. **Cloudflare Accessの導入**:
   - Cloudflare Accessを使用して、アプリケーションへのアクセスを認証前に制限
   - Workersに到達する前のエッジレベルでアクセス制御を行う
   - 無料プラン（50ユーザーまで）で十分な機能を利用

2. **カスタムドメインの導入**:
   - 自動生成されたCloudflare WorkersのURLではなく、カスタムドメインを使用
   - ドメイン名はプライベートな情報に基づき、予測困難なものを選択

3. **WAF (Web Application Firewall) ルールの設定**:
   - レート制限を設定して短時間での大量リクエストをブロック
   - 悪意のあるトラフィックパターンを検出してブロック

4. **地理的アクセス制限**:
   - 自分が使用する国や地域からのアクセスのみを許可

5. **アプリケーションレベルでは軽量JWT認証の維持**:
   - バックアップおよび多層防御の一部として JWT認証を維持
   - 拡張機能との連携に引き続き活用

## 根拠

この決定の主な根拠：

1. **ネットワーク層での防御**: Cloudflareのエッジでリクエストをフィルタリングすることで、Workersのリソース消費を事前に防止できる
2. **多層防御**: 単一の防御メカニズムではなく、複数の防御層を組み合わせることでセキュリティを強化
3. **運用コスト**: Cloudflareの既存機能を活用することで、カスタム実装のオーバーヘッドを削減
4. **拡張機能連携の維持**: JWT認証を残すことで、拡張機能との一貫した認証体験を維持
5. **無料プランの十分性**: 調査結果から、個人利用の場合はCloudflare Accessの無料プラン（50ユーザーまで）で十分な機能が利用可能

## 結果

この決定により、以下の結果が予想される：

### ポジティブな結果

1. Cloudflare Workersに到達するリクエストが認証済みのものに限定され、リソース消費が大幅に低減
2. ボット、クローラー、悪意のあるトラフィックからのアクセスが防止される
3. 複数の防御層により、単一の脆弱性が全体のセキュリティを損なうリスクが低減
4. 無料プランで利用可能なため、追加コストなしで実装可能

### ネガティブな結果

1. 設定の複雑さが増加し、初期セットアップの手間が増える
2. ユーザー体験に認証の追加ステップが導入される
3. Cloudflareのサービスへの依存度が高まる

### 中立的な結果

1. 認証フローが変更され、ユーザー（自分自身）の学習コストが発生
2. 拡張機能連携の方法が若干複雑になる可能性

## オプションと代替案

検討した代替案は以下の通り：

1. **専用VPSへの移行**
   - メリット: 完全なコントロールと固定IPによるアクセス制限
   - デメリット: 運用コストの増加、Cloudflareの利点喪失

2. **非公開モードでのデプロイ**
   - メリット: 外部からのアクセスがなくなる
   - デメリット: 複数デバイスからのアクセス、拡張機能連携が困難に

3. **Application-level認証のみ（ADR-001アプローチ）**
   - メリット: 実装が比較的簡単
   - デメリット: リソース消費問題の根本的な解決にならない

4. **IP制限のみ**
   - メリット: シンプルな実装
   - デメリット: 動的IPの問題、複数の場所からのアクセスが困難

## 実装詳細

### 1. Cloudflare Accessの設定

1. **Zero Trustアカウントの作成**:
   - Cloudflare Dashboardから「Zero Trust」セクションにアクセス
   - チーム名を設定し、無料プランを選択

2. **アプリケーションの登録**:
   - 「Access」→「Applications」から新規アプリケーションを追加
   - アプリケーション名とドメインを設定
   - セッション期間を適宜設定（例：30日）

3. **アクセスポリシーの設定**:
   - 個人用ポリシーを作成
   - メールアドレスまたはソーシャルIDに基づく認証を設定
   - 地理的条件やデバイス条件を追加（必要に応じて）

### 2. カスタムドメインの設定

1. **DNSレコードの設定**:
   - 個人所有ドメインのCNAMEレコードをCloudflare Workersに向ける
   - SSL/TLS設定を「Full」に設定

2. **Workersのカスタムドメイン設定**:
   - Workersの設定からカスタムドメインを追加
   - ルートパスとルーティングを設定

### 3. WAFとセキュリティ設定

1. **レート制限の設定**:
   - 「Security」→「WAF」→「Rate limiting rules」から新規ルールを追加
   - 適切なしきい値（例：1分間に100リクエスト）を設定

2. **セキュリティルールの追加**:
   - 既知の悪意あるIPやボットパターンをブロック
   - 異常なリクエストパターンに対するルールを設定

### 4. 地理的アクセス制限

1. **アクセス制御設定**:
   - 「Security」→「WAF」→「Firewall rules」から新規ルールを追加
   - 「Country equals JP」などの条件を設定

### 5. JWT認証の実装（バックアップ）

1. **認証エンドポイントの実装**:
   - `/auth/login`エンドポイントの作成
   - 固定認証情報と環境変数による検証

2. **JWTミドルウェアの設定**:
   - Honoのミドルウェアを使用してJWT検証を実装
   - 長期間有効なトークンを発行

3. **拡張機能連携**:
   - 拡張機能での認証トークン管理機能の実装
   - APIリクエスト時のトークン添付

## 注記

この多層防御アプローチは、Cloudflare Workersのリソース消費問題に対する効果的な解決策となります。Cloudflare Accessを使用することで、リクエストがWorkersに到達する前にエッジレベルでフィルタリングされるため、無料枠の消費を大幅に削減できます。

調査結果から、個人利用の場合はCloudflare Accessの無料プラン（50ユーザーまで）で十分であり、追加コストなしで実装可能であることが確認されました。

実装の複雑さは増しますが、得られるセキュリティとリソース保護の利点は十分に価値があります。
