# ADR 002: ネットワーク層でのリソース保護対策

## 日時

2025-04-07

## コンテキスト

ADR-001では、JWT認証によるアプリケーションレベルでの保護を検討したが、これだけではCloudflare Workersのリソース消費問題を根本的に解決できないことが明らかになった。JWT認証のみでは以下の課題が残る：

1. **リクエスト処理オーバーヘッド**: 認証が失敗しても、リクエスト自体はCloudflare Workersで処理されるため、リソースは消費される
2. **認証エンドポイントの脆弱性**: 認証エンドポイント自体が攻撃対象となり得る
3. **DoS攻撃の可能性**: 大量のリクエストが送信された場合、認証処理自体がリソースを消費する

Effective Yomimonoは個人利用のプロジェクトであり、パブリックなインターネット上で公開URLを持つことによるリスクを最小化する必要がある。

## 決定

**Cloudflareのネットワーク層機能を活用した多層防御アプローチを採用する。**

具体的には：

1. **カスタムドメインの導入**:
   - 自動生成されたCloudflare WorkersのURLではなく、カスタムドメインを使用
   - ドメイン名はプライベートな情報に基づき、予測困難なものを選択

2. **Cloudflare Accessの導入**:
   - Cloudflare Accessを使用して、アプリケーションへのアクセスを認証前に制限
   - シングルサインオン(SSO)またはSocial認証(Google, GitHub等)を活用

3. **WAF (Web Application Firewall) ルールの設定**:
   - レート制限を設定して短時間での大量リクエストをブロック
   - 悪意のあるトラフィックパターンを検出してブロック

4. **地理的アクセス制限**:
   - 自分が使用する国や地域からのアクセスのみを許可

5. **アプリケーションレベルでは軽量JWT認証の維持**:
   - バックアップおよび多層防御の一部として JWT認証を維持
   - 拡張機能との連携に引き続き活用

## 根拠

この決定の主な根拠：

1. **ネットワーク層での防御**: Cloudflareのエッジでリクエストをフィルタリングすることで、Workersのリソース消費を事前に防止できる
2. **多層防御**: 単一の防御メカニズムではなく、複数の防御層を組み合わせることでセキュリティを強化
3. **運用コスト**: Cloudflareの既存機能を活用することで、カスタム実装のオーバーヘッドを削減
4. **拡張機能連携の維持**: JWT認証を残すことで、拡張機能との一貫した認証体験を維持

## 結果

この決定により、以下の結果が予想される：

### ポジティブな結果

1. Cloudflare Workersに到達するリクエストが認証済みのものに限定され、リソース消費が大幅に低減
2. ボット、クローラー、悪意のあるトラフィックからのアクセスが防止される
3. 複数の防御層により、単一の脆弱性が全体のセキュリティを損なうリスクが低減

### ネガティブな結果

1. Cloudflare Accessの無料枠を超えると追加コストが発生する可能性
2. 設定の複雑さが増加し、初期セットアップの手間が増える
3. ユーザー体験に認証の追加ステップが導入される

### 中立的な結果

1. 認証フローが変更され、ユーザー（自分自身）の学習コストが発生
2. 拡張機能連携の方法が若干複雑になる可能性

## オプションと代替案

検討した代替案は以下の通り：

1. **専用VPSへの移行**
   - メリット: 完全なコントロールと固定IPによるアクセス制限
   - デメリット: 運用コストの増加、Cloudflareの利点喪失

2. **非公開モードでのデプロイ**
   - メリット: 外部からのアクセスがなくなる
   - デメリット: 複数デバイスからのアクセス、拡張機能連携が困難に

3. **Application-level認証のみ（ADR-001アプローチ）**
   - メリット: 実装が比較的簡単
   - デメリット: リソース消費問題の根本的な解決にならない

4. **IP制限のみ**
   - メリット: シンプルな実装
   - デメリット: 動的IPの問題、複数の場所からのアクセスが困難

## 実装詳細

1. **カスタムドメイン設定**
   - 個人所有ドメインのサブドメインをCloudflare Workersに接続
   - DNSレコードと証明書の設定

2. **Cloudflare Access設定**
   - アプリケーションの登録
   - アクセスポリシーの設定（許可するID、認証方法）
   - Cookieベースの認証の設定

3. **WAF設定**
   - レート制限ルールの作成
   - セキュリティレベルの設定
   - カスタムルールの追加（必要に応じて）

4. **地理的制限の設定**
   - 使用する国/地域の指定
   - 例外ルールの設定（必要に応じて）

5. **拡張機能の更新**
   - Cloudflare Access認証との連携
   - JWTトークン管理の維持

## 注記

この多層防御アプローチは、より高度なセキュリティを提供する一方で、設定の複雑さとポテンシャルな運用コストを増加させる。個人プロジェクトのため、コストとセキュリティのバランスを定期的に再評価し、必要に応じて調整する必要がある。

また、Cloudflare Accessの無料枠の制限（ユーザー数、リクエスト数など）を確認し、予想される使用パターンに合わせて適切なプランを選択する。
