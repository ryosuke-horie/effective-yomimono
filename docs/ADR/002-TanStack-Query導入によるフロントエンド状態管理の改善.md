# ADR-002: TanStack Query (React Query) 導入によるフロントエンド状態管理の改善

## ステータス

承認済み

## コンテキスト

フロントエンドのブックマークリスト (`BookmarkCard`, `BookmarksList`) において、個別のブックマークに対する操作（既読、お気に入り追加/削除）を行うと、リスト全体が API から再取得され、再レンダリングされる問題が発生していた。これはユーザー体験の低下（操作に対する反応の遅延、画面のちらつき）と、不要な API 負荷の原因となっていた。

現状の実装では、`useBookmarks` フック内で `fetch` API を直接使用し、`useState` でサーバーから取得したデータを管理していた。状態更新時にはリスト全体のデータを再取得する方式を採用していたため、上記の問題が発生していた。

この問題を解決し、より効率的で応答性の高い UI を実現するために、サーバー状態管理ライブラリの導入を検討した。

## 決定

フロントエンドのサーバー状態管理ライブラリとして **TanStack Query (React Query) v5** を導入する。

導入に伴い、以下の対応を行う。

1.  既存の `useBookmarks` フック内の手動 `fetch` と `useState` によるサーバー状態管理ロジックを、TanStack Query の `useQuery` および `useMutation` を使用するようにリファクタリングする。
2.  ブックマークの既読化およびお気に入り操作において、`useMutation` の**楽観的更新 (Optimistic Updates)** 機能を利用し、ユーザー操作に対する即時フィードバックとスムーズな UI 更新を実現する。
3.  データ取得・更新ロジックをコンポーネントから分離し、`frontend/src/queries` (または類似のディレクトリ) 配下のカスタムフックに集約する。

## 検討された選択肢

1.  **現状維持 (手動 fetch + useState):** 問題が解決しないため却下。
2.  **状態の部分更新 (手動実装):** API 負荷とレンダリングは改善できるが、キャッシュ管理やバックグラウンド更新、楽観的更新などの複雑なロジックを自前で実装する必要があり、開発コストが高い。
3.  **他の状態管理ライブラリ (例: SWR, Zustand, Redux Toolkit):** TanStack Query はサーバー状態管理に特化しており、キャッシュ管理、バックグラウンド更新、楽観的更新などの機能が豊富で、今回の要件に最も適していると判断。特に v5 で楽観的更新のサポートが強化された点が決め手となった。

## 結果

### ポジティブな影響

*   **ユーザー体験の向上:** 楽観的更新により、操作に対する UI の反応速度が大幅に向上する。画面のちらつきが解消される。
*   **パフォーマンス改善:** 不要な API 呼び出しとリスト全体の再レンダリングが削減され、フロントエンドのパフォーマンスが向上する。サーバー負荷も軽減される。
*   **コードの簡潔化:** TanStack Query がキャッシュ管理、ローディング/エラー状態管理、再試行などの定型処理を担当するため、コンポーネントやカスタムフックのコードがシンプルになる。
*   **開発効率の向上:** サーバー状態管理に関するボイラープレートコードが削減される。
*   **技術的負債の削減:** モダンで広く使われているライブラリを導入することで、将来的なメンテナンス性が向上する。

### ネガティブな影響

*   **学習コスト:** TanStack Query の概念（クエリキー、キャッシュ、ミューテーション、楽観的更新など）を理解する必要がある。
*   **依存関係の追加:** 新しいライブラリへの依存が発生する。
*   **初期実装コスト:** 既存ロジックのリファクタリングが必要となる。

## 次のステップ

決定に基づき、TanStack Query の導入と関連コードのリファクタリングを **Act mode** で実施する。
