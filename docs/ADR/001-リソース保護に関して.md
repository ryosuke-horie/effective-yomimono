# ADR 001: リソース保護のための認証機能実装

## 日時

2025-04-07

## コンテキスト

Effective Yomimonoは現在、フロントエンドとAPIの両方がCloudflare Workersにデプロイされており、認証機能なしで公開されている。これにより以下の課題が生じている：

1. **アクセス制限がない**: 誰でもアプリケーションにアクセスできる状態である
2. **リソース消費リスク**: 公開URLに対する意図しないアクセスやループアクセスにより、Cloudflare Workersの無料枠が消費される可能性がある

当初は、個人利用を前提とした単純なユーザー体験を優先していたため、認証機能は後回しにされていた。しかし、Cloudflare Workersの実行時間が無料枠内で制限されていることを考慮すると、不正アクセスやボットによるアクセスからアプリケーションを保護する必要性が高まっている。

## 決定

**リソース保護を主目的とした軽量認証システムを実装する。**

具体的には：

1. JWT（JSON Web Tokens）ベースの認証メカニズムを導入する
2. 環境変数で管理される固定の認証情報（単一ユーザー前提）を使用する
3. データベースにユーザーテーブルは追加せず、シンプルな実装を維持する
4. すべてのAPIエンドポイントに認証を要求する
5. フロントエンドアプリケーションも認証で保護する
6. ブラウザ拡張機能もAPIアクセス時に認証トークンを使用する

## 根拠

この決定の主な根拠：

1. **リソース保護が主目的**: データベース連携を含む完全なユーザー管理システムではなく、Cloudflare Workersリソースの保護が主目的であるため、シンプルな実装で十分である
2. **開発コストの最小化**: 個人利用のプロジェクトであり、複雑な認証システムの構築に時間をかけるよりも、シンプルな保護メカニズムを迅速に実装する方が効率的である
3. **将来の拡張性**: JWTベースの認証は、将来的に必要に応じてユーザーデータベースと連携できる柔軟性を持つ
4. **メンテナンスの容易さ**: 認証情報を環境変数で管理することで、データベースマイグレーションなどの複雑な運用が不要になる

## 結果

この決定により、以下の結果が予想される：

### ポジティブな結果

1. Cloudflare Workersの無料枠消費リスクが低減される
2. 個人データがある程度保護される
3. 開発・運用の複雑さが最小限に抑えられる
4. 将来的な拡張性が確保される

### ネガティブな結果

1. 複数ユーザーへの拡張が容易ではない
2. 高度なユーザー管理機能（パスワードリセットなど）の実装が困難
3. 認証情報を環境変数で管理するため、認証情報の変更にはデプロイが必要

### 中立的な結果

1. ユーザー体験に認証ステップが追加される
2. トークン管理が必要になる（フロントエンドと拡張機能の両方）

## オプションと代替案

検討した代替案は以下の通り：

1. **データベースを使用したユーザー管理システム**
   - メリット: 将来的な複数ユーザー対応や高度な認証機能の基盤となる
   - デメリット: 開発コストが高く、現在のニーズ（リソース保護）に対して過剰

2. **Cloudflare Accessの利用**
   - メリット: Cloudflareのエコシステム内で統合された認証
   - デメリット: 追加コストが発生する可能性があり、拡張機能連携が複雑になる

3. **Basic認証の導入**
   - メリット: 実装が極めて簡単
   - デメリット: ユーザー体験が悪く、セキュリティレベルが低い

4. **認証なしでIP制限のみ実施**
   - メリット: 認証システムが不要
   - デメリット: 固定IPがない場合は実用的でなく、拡張機能連携が困難

## 実装詳細

実装の主な要素：

1. **JWT認証の実装**
   - Hono.jsのJWTミドルウェアを使用
   - 30日などの長期間有効なトークンを発行

2. **APIの保護**
   - すべてのAPIエンドポイントに認証ミドルウェアを適用
   - 認証エンドポイント（/auth/login）のみ例外として公開

3. **フロントエンドの保護**
   - ログイン画面の実装
   - 認証状態管理
   - トークンの安全な保存

4. **拡張機能の連携**
   - トークン設定機能の追加
   - APIリクエスト時のトークン添付

## 注記

この認証方式は主にリソース保護のためのものであり、高度なセキュリティ要件には対応していないことに留意する。将来的にプロジェクトの性質やニーズが変わった場合は、より包括的な認証システムへの移行を検討する。
