# 拡張機能API設計

## API連携概要

拡張機能は、選択されたタブの情報をEffective YomimonoのAPIエンドポイントに送信します。この連携により、ユーザーが選択したウェブページが未読ブックマークとしてシステムに保存されます。

## エンドポイント詳細

### ブックマーク一括登録エンドポイント

- **URL**: `https://effective-yomimono-api.ryosuke-horie37.workers.dev/api/bookmarks/bulk`
- **メソッド**: POST
- **Content-Type**: application/json

#### リクエスト仕様

```json
{
  "bookmarks": [
    {
      "url": "https://example.com/article1",
      "title": "記事タイトル1"
    },
    {
      "url": "https://example.com/article2",
      "title": "記事タイトル2"
    }
    // 複数のブックマークを一度に送信可能
  ]
}
```

#### レスポンス仕様

**成功時（200 OK）**:
```json
{
  "success": true,
  "message": "Processed X bookmarks (duplicates skipped if unread)"
}
```

**エラー時（400 Bad Request）**:
```json
{
  "success": false,
  "message": "エラーメッセージ（例: bookmarks must be an array）"
}
```

**エラー時（500 Internal Server Error）**:
```json
{
  "success": false,
  "message": "Failed to create bookmarks"
}
```

## API通信処理フロー

1. **データ収集**:
   - ポップアップUIで選択されたタブの情報（URL、タイトル）を収集
   - 収集したデータをバックグラウンドスクリプトに送信

2. **リクエスト準備**:
   - バックグラウンドスクリプトでリクエストボディを構築
   - Content-Typeヘッダーを設定

3. **API通信**:
   - Fetch APIを使用してPOSTリクエストを送信
   - レスポンスを非同期で待機

4. **レスポンス処理**:
   - レスポンスのステータスコードを確認
   - エラーの場合は適切なエラーメッセージを抽出
   - 成功の場合はレスポンスデータをJSON形式で解析

5. **結果通知**:
   - 処理結果をポップアップUIに返信
   - 成功またはエラーメッセージをユーザーに表示

## エラーハンドリング

1. **ネットワークエラー**:
   - 通信エラーが発生した場合はエラーメッセージをキャッチ
   - エラー詳細をコンソールに記録
   - ユーザーに通信エラーが発生したことを通知

2. **APIエラー**:
   - APIからのエラーレスポンス（非200ステータス）を処理
   - エラーメッセージをレスポンスから抽出
   - ステータスコードとエラーメッセージをユーザーに表示

3. **データ検証エラー**:
   - APIサイドでのデータ検証エラー（無効なURL形式など）を処理
   - 検証エラーメッセージをユーザーに表示

## セキュリティ考慮事項

1. **クロスオリジンリクエスト**:
   - 拡張機能のマニフェストで適切なホスト権限を設定
   - APIエンドポイントへのアクセス権限を確保

2. **エラー情報の取り扱い**:
   - 詳細なエラー情報はコンソールにのみ記録
   - ユーザーには適切に抽象化されたエラーメッセージを表示

3. **権限の最小化**:
   - 拡張機能は必要最小限の権限（tabs、activeTab）のみを要求
   - ホスト権限も必要なAPIエンドポイントに限定
