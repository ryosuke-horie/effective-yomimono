# Cloudflare D1 マイグレーションガイド

## 概要
このドキュメントは、Cloudflare D1データベースのスキーマ変更を安全に実行するための手順とベストプラクティスを提供します。

## 背景
過去にお気に入り機能の更新時に、外部キー制約を一時的に無効化したことでデータが消えるバグが発生しました。このような問題を防ぐため、適切なバックアップとマイグレーション手順が必要です。

## マイグレーションの流れ

### 1. 事前準備
1. 現在のスキーマ状態を確認
   ```bash
   cd api
   npx drizzle-kit status
   ```

2. 新しいマイグレーションファイルの生成
   ```bash
   npx drizzle-kit generate
   ```

3. 生成されたSQLファイルのレビュー
   - `api/drizzle/` ディレクトリに生成されたファイルを確認
   - 特に `PRAGMA foreign_keys=OFF` が使用される場合は要注意

### 2. バックアップ

#### 開発環境
```bash
# ローカルデータベースのエクスポート
wrangler d1 export yomimono-db --local > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 本番環境
```bash
# 本番データベースのエクスポート（要権限）
wrangler d1 export yomimono-db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 3. マイグレーション実行

#### 開発環境
```bash
npm run migrate:development
```

#### 本番環境
**重要**: 本番環境での実行は慎重に行ってください
```bash
npm run migrate:production
```

### 4. 検証
1. データの整合性確認
   - お気に入りデータが正しく保持されているか
   - 外部キー関係が正しいか

2. アプリケーションのテスト
   ```bash
   npm test
   ```

## 注意事項

### 外部キー制約に関する問題
DrizzleのマイグレーションでSQLiteのテーブル変更を行う際、`PRAGMA foreign_keys=OFF`を使用してテーブルを再作成することがあります。この過程で以下のリスクがあります：

1. **データ消失**: 外部キー制約が一時的に無効になるため、依存データが失われる可能性
2. **順序の問題**: テーブルの再作成順序によってはデータの不整合が発生

### 推奨される対策
1. **段階的なマイグレーション**: 大きな変更は複数の小さなマイグレーションに分割
2. **データ検証スクリプトの実装**: マイグレーション前後でのデータ比較
3. **トランザクションの使用**: 可能な限りトランザクション内で実行

## トラブルシューティング

### データ消失時の復旧
1. バックアップファイルから復元
   ```bash
   wrangler d1 execute yomimono-db --file=backup_YYYYMMDD_HHMMSS.sql
   ```

2. 特定のテーブルのみ復元が必要な場合は、バックアップSQLから該当部分を抽出

### マイグレーション失敗時
1. エラーログの確認
2. 部分的に適用されたマイグレーションの手動ロールバック
3. データベースの状態をクリーンに戻してから再実行

## ベストプラクティス

1. **常にバックアップを取る**
   - マイグレーション前に必ずバックアップ
   - バックアップファイルは日付付きで保存

2. **開発環境で十分にテスト**
   - 本番と同じデータ構造でテスト
   - エッジケースも考慮

3. **監視とロギング**
   - マイグレーション実行時のログを保存
   - 実行前後のデータ数を記録

4. **ロールバック計画**
   - マイグレーション失敗時の手順を事前に準備
   - ロールバックスクリプトの準備

## 今後の改善提案

1. **自動化スクリプトの作成**
   - バックアップ、検証、マイグレーションを一連のフローで実行
   - エラー時の自動ロールバック

2. **CI/CDへの統合**
   - テスト環境での自動検証
   - ステージング環境での事前テスト

3. **監視ツールの導入**
   - データ整合性の自動チェック
   - マイグレーション後の異常検知