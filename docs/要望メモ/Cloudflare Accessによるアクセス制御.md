# Cloudflare Accessによるアクセス制御

## 背景

Yomimonoプロジェクトでは、Cloudflare Workersの無料枠リソース消費を防ぎ、個人用ツールとしての特性を考慮して、Cloudflare Accessを利用したネットワーク層でのアクセス制御を実装することが決定されています（ADR-001参照）。

## 実装タスク

### 1. Zero Trustアカウント設定
- Zero Trustアカウントの作成
- ダッシュボードへのアクセス確認
- 無料プランの制限確認

### 2. フロントエンドアプリケーション設定
- Zero Trustダッシュボードにフロントエンドアプリケーションを登録
- ユーザー認証方式の設定 (Google)
- アクセスポリシーの設定
- セッション有効期限の設定
- 認証画面のカスタマイズ（必要に応じて）
- `依存: タスク1完了後に実施`

### 3. サービストークン生成
- API用のサービストークンを生成
- トークンの安全な保管方法の確立
- トークンローテーションの計画作成
- `依存: タスク1完了後に実施`

### 4. バックエンドAPIのアクセス制御設定
- Zero TrustダッシュボードにAPIアプリケーションを登録
- サービストークンベースの認証設定
- 必要なCORS設定の調整
- `依存: タスク1とタスク3完了後に実施`

### 5. フロントエンドとAPIの連携調整
- フロントエンドコードにトークン管理機能の実装
- API呼び出し時に認証ヘッダー (`CF-Access-Client-Id`と`CF-Access-Client-Secret`) を追加
- クロスドメインリクエスト処理の確認
- エラーハンドリングの実装
- `依存: タスク2とタスク4完了後に実施`

### 6. ブラウザ拡張機能の対応
- 拡張機能コードにサービストークンを組み込み
- API呼び出し時の認証ヘッダー追加
- 安全なトークン管理方法の実装
- エラーハンドリングの改善
- `依存: タスク3完了後に実施`

### 7. WAFとレート制限の設定
- Cloudflare WAFルールの設定
- レート制限の設定
- ボット対策の設定
- `依存: タスク4完了後に実施`

### 8. 地理的アクセス制限
- 利用する主な地域のみアクセスを許可するよう設定
- IPベースのアクセス制限検討
- 例外ルールの設定（必要に応じて）
- `依存: タスク4完了後に実施`

### 9. 統合テスト
- 全コンポーネント間の連携確認
- ユーザー認証フローのテスト
- サービストークン認証のテスト
- エラーケースのテスト
- `依存: タスク5とタスク6完了後に実施`

### 10. 本番環境への移行
- 段階的な移行計画の作成
- 移行の実行
- 移行後の監視と問題対応
- `依存: タスク7、タスク8、タスク9完了後に実施`

## 注意事項

- CORS関連の問題に早期に対応するため、クロスドメイン認証のテストを優先的に行う
- サービストークンは環境変数として扱い、ソースコードへの直接埋め込みを避ける
- ブラウザ拡張機能のトークン管理には特に注意が必要
- 移行時にはいつでもロールバックできる体制を整えておく
- サービストークンの定期的なローテーション手順を確立する

## 参考リソース

- [Cloudflare Zero Trust 入門ガイド](https://developers.cloudflare.com/cloudflare-one/setup/)
- [アプリケーション設定方法](https://developers.cloudflare.com/cloudflare-one/applications/configure-apps/)
- [サービストークンのドキュメント](https://developers.cloudflare.com/cloudflare-one/identity/service-tokens/)
- [CORSの設定](https://developers.cloudflare.com/cloudflare-one/identity/authorization-cookie/cors/)
- [レート制限の設定](https://developers.cloudflare.com/waf/rate-limiting-rules/)
