# テスト戦略ドキュメント

## 1. テストの方針

### 1.1 テストの目的
- コードの品質保証
- リグレッションの防止
- コードの仕様ドキュメントとしての役割
- エッジケースの検証

### 1.2 テストレベル

#### Unit Tests
- 各コンポーネントの独立したテスト
- モックを活用した依存関係の分離
- 境界値テストの実施

#### Integration Tests
- コンポーネント間の連携テスト
- エンドポイントの実際の動作確認
- エラーハンドリングの検証

## 2. テスト対象とテストケース

### 2.1 Repository Layer (`DrizzleBookmarkRepository`)

#### テスト対象
- `createMany` メソッド

#### テストケース
1. 正常系
   - 複数のブックマークを正常に保存できる
   - 空の配列を渡した場合の動作確認

2. 異常系
   - DBエラー発生時の例外ハンドリング
   - トランザクションの確認

### 2.2 Service Layer (`DefaultBookmarkService`)

#### テスト対象
- `createBookmarksFromUrls` メソッド
- `fetchTitleFromUrl` メソッド（private）

#### テストケース
1. 正常系
   - 複数URLからタイトルを取得してブックマークを作成
   - タイトルが取得できないURLの処理
   - 既存URLの重複チェック

2. 異常系
   - 無効なURL形式
   - ネットワークエラー
   - タイムアウト
   - リポジトリエラー

### 2.3 Router Layer (bookmarks.ts)

#### テスト対象
- POST /bulk エンドポイント

#### テストケース
1. リクエストバリデーション
   - 有効なURLの配列
   - 無効なURL形式
   - 配列サイズの制限（1-10件）
   - 不正なリクエスト形式

2. レスポンス
   - 成功時のレスポンス形式
   - 各種エラー時のレスポンス形式
   - HTTPステータスコード

## 3. テスト実装方針

### 3.1 テストツール
- Vitest: テストランナー
- MSW (Mock Service Worker): HTTPリクエストのモック
- @hono/testing: Honoのテストユーティリティ

### 3.2 モック戦略
1. Repository Layer
   - D1 Databaseのモック
   - SQLクエリの実行結果のモック

2. Service Layer
   - fetchのモック（MSW）
   - リポジトリ層のモック

3. Router Layer
   - サービス層のモック
   - リクエスト/レスポンスのモック

### 3.3 テストデータ
- フィクスチャーの活用
- テストケース別のデータセット
- エッジケース用のデータ

### 3.4 テストの配置

```
api/
├── src/
│   └── ...
└── tests/
    ├── unit/
    │   ├── repositories/
    │   │   └── bookmark.test.ts
    │   ├── services/
    │   │   └── bookmark.test.ts
    │   └── routes/
    │       └── bookmarks.test.ts
    ├── integration/
    │   └── bookmarks.test.ts
    └── __fixtures__/
        └── bookmarks.ts
```

## 4. CI/CD統合

### 4.1 テスト実行タイミング
- プルリクエスト作成時
- mainブランチへのマージ時
- デプロイ前

### 4.2 テストカバレッジ
- ステートメントカバレッジ: 80%以上
- ブランチカバレッジ: 70%以上
- 重要なビジネスロジックは100%を目指す

## 5. テストメンテナンス

### 5.1 レビュー基準
- テストケースの網羅性
- テストの可読性
- テストの独立性
- モックの適切な使用

### 5.2 更新方針
- 機能追加時の関連テストの追加
- バグ修正時の回帰テストの追加
- 定期的なテストコードのリファクタリング